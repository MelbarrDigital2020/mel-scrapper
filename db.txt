CREATE TABLE IF NOT EXISTS companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  name              VARCHAR(255) NOT NULL,
  domain            VARCHAR(255) UNIQUE,   -- email domain / primary domain
  website           TEXT,

  -- Industry
  industry          VARCHAR(255),          -- cleaned/normalized industry if you want
  raw_industry      TEXT,                  -- exact industry string from source (ZoomInfo/raw)

  -- Employee & Revenue
  raw_employee      VARCHAR(50),           -- exact employee count text from source (ex: "5200", "5,001-10,000")
  employee_range    VARCHAR(50),           -- standardized range bucket (ex: "5001-10000")

  raw_revenue       VARCHAR(100),          -- exact revenue text from source (ex: "$3.3 Billion")
  revenue_range     VARCHAR(50),           -- standardized range bucket (ex: "1B-5B")

  -- Address
  address_line1     TEXT,                  -- first line from source (ex: "Helsinki Airport 9 a Tietotie")
  full_address      TEXT,                  -- full address combined in one column

  city              VARCHAR(120),
  state             VARCHAR(120),
  province          VARCHAR(120),
  postal_code       VARCHAR(30),
  country           VARCHAR(120),

  -- Company Contact Number (ZoomInfo)
  company_phone     VARCHAR(30),

  linkedin_url      TEXT,

  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  source VARCHAR(50),
);


-- Helpful Indexes
CREATE INDEX IF NOT EXISTS idx_companies_name ON companies (name);
CREATE INDEX IF NOT EXISTS idx_companies_domain ON companies (domain);
CREATE INDEX IF NOT EXISTS idx_companies_country ON companies (country);
CREATE INDEX IF NOT EXISTS idx_companies_industry ON companies (industry);


CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_companies_updated_at ON companies;

CREATE TRIGGER trg_companies_updated_at
BEFORE UPDATE ON companies
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();


CREATE TABLE IF NOT EXISTS contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Relation
  company_id UUID,
  CONSTRAINT fk_contacts_company
    FOREIGN KEY (company_id)
    REFERENCES companies(id)
    ON DELETE SET NULL,

  -- Identity
  email              VARCHAR(255) UNIQUE,
  email_domain       VARCHAR(255),
  email_status       VARCHAR(155) NOT NULL DEFAULT 'unknown',

  first_name         VARCHAR(120),
  last_name          VARCHAR(120),

  -- Job info
  job_title          VARCHAR(255),     -- jobtitle
  job_level          VARCHAR(120),     -- job_level__c

  linkedin_url       TEXT,             -- linkedinurl__c

  -- Location (person)
  address_line1      TEXT,
  full_address       TEXT,
  city               VARCHAR(120),
  state              VARCHAR(120),
  province           VARCHAR(120),
  postal_code        VARCHAR(30),
  country            VARCHAR(120),

  -- Enrichment
  connections_count  INTEGER,          -- Conn

  -- Lead management
  lead_temp          VARCHAR(55) NOT NULL DEFAULT 'cold',
  lead_stage         VARCHAR(55) NOT NULL DEFAULT 'new',
  lead_score         INTEGER NOT NULL DEFAULT 0,

  -- Timestamps
  created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_contacts_company_id ON contacts (company_id);
CREATE INDEX IF NOT EXISTS idx_contacts_email_domain ON contacts (email_domain);
CREATE INDEX IF NOT EXISTS idx_contacts_lead_temp ON contacts (lead_temp);
CREATE INDEX IF NOT EXISTS idx_contacts_lead_stage ON contacts (lead_stage);

-- updated_at trigger
DROP TRIGGER IF EXISTS trg_contacts_updated_at ON contacts;

CREATE TRIGGER trg_contacts_updated_at
BEFORE UPDATE ON contacts
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();


-- 1) Enum for job status
DO $$ BEGIN
  CREATE TYPE export_job_status AS ENUM (
    'queued',
    'processing',
    'completed',
    'failed'
  );
EXCEPTION
  WHEN duplicate_object THEN null;
END $$;

-- 2) Export jobs table
CREATE TABLE IF NOT EXISTS public.export_jobs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  entity text NOT NULL,              -- 'contacts' | 'companies'
  mode text NOT NULL,                -- 'selected' | 'filtered'
  format text NOT NULL,              -- 'csv' | 'excel'
  status text NOT NULL DEFAULT 'queued',  -- queued | processing | completed | failed

  headers jsonb NOT NULL,
  ids jsonb,
  query jsonb,

  row_count int,
  file_name text,
  file_path text,                    -- where you saved it in project directory
  file_size_bytes bigint,

  error_message text,

  created_at timestamptz NOT NULL DEFAULT now(),
  started_at timestamptz,
  finished_at timestamptz,
  delivered_at timestamptz           -- when user actually downloads
);

CREATE INDEX IF NOT EXISTS idx_export_jobs_user_created
  ON public.export_jobs (user_id, created_at DESC);

-- Helpful indexes
CREATE INDEX IF NOT EXISTS idx_export_jobs_user_id_created_at
  ON public.export_jobs (user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_export_jobs_status_created_at
  ON public.export_jobs (status, created_at DESC);

  ALTER TABLE public.export_jobs
ADD COLUMN IF NOT EXISTS download_token text,
ADD COLUMN IF NOT EXISTS download_token_expires_at timestamptz,
ADD COLUMN IF NOT EXISTS email_sent_at timestamptz;

CREATE INDEX IF NOT EXISTS export_jobs_download_token_idx
ON public.export_jobs (download_token);


-- sync_jobs: one row per sync run
CREATE TABLE IF NOT EXISTS sync_jobs (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('queued','running','completed','failed')),
  progress INT NOT NULL DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),

  options JSONB NOT NULL DEFAULT '{}'::jsonb,
  result JSONB,
  error TEXT,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  finished_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_sync_jobs_user_created
  ON sync_jobs (user_id, created_at DESC);

-- sync_tasks: one row per task inside a job (companies / contacts)
CREATE TABLE IF NOT EXISTS sync_tasks (
  id UUID PRIMARY KEY,
  job_id UUID NOT NULL REFERENCES sync_jobs(id) ON DELETE CASCADE,

  key TEXT NOT NULL CHECK (key IN ('companies','contacts')),
  label TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('queued','running','completed','failed')),
  progress INT NOT NULL DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),

  started_at TIMESTAMPTZ,
  finished_at TIMESTAMPTZ,
  error TEXT,
  result JSONB,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- prevent duplicates per job
CREATE UNIQUE INDEX IF NOT EXISTS ux_sync_tasks_job_key
  ON sync_tasks (job_id, key);

CREATE INDEX IF NOT EXISTS idx_sync_tasks_job
  ON sync_tasks (job_id);
