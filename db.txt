CREATE TABLE IF NOT EXISTS companies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  name              VARCHAR(255) NOT NULL,
  domain            VARCHAR(255) UNIQUE,   -- email domain / primary domain
  website           TEXT,

  -- Industry
  industry          VARCHAR(255),          -- cleaned/normalized industry if you want
  raw_industry      TEXT,                  -- exact industry string from source (ZoomInfo/raw)

  -- Employee & Revenue
  raw_employee      VARCHAR(50),           -- exact employee count text from source (ex: "5200", "5,001-10,000")
  employee_range    VARCHAR(50),           -- standardized range bucket (ex: "5001-10000")

  raw_revenue       VARCHAR(100),          -- exact revenue text from source (ex: "$3.3 Billion")
  revenue_range     VARCHAR(50),           -- standardized range bucket (ex: "1B-5B")

  -- Address
  address_line1     TEXT,                  -- first line from source (ex: "Helsinki Airport 9 a Tietotie")
  full_address      TEXT,                  -- full address combined in one column

  city              VARCHAR(120),
  state             VARCHAR(120),
  province          VARCHAR(120),
  postal_code       VARCHAR(30),
  country           VARCHAR(120),

  -- Company Contact Number (ZoomInfo)
  company_phone     VARCHAR(30),

  linkedin_url      TEXT,

  created_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at        TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  source VARCHAR(50),
);


-- Helpful Indexes
CREATE INDEX IF NOT EXISTS idx_companies_name ON companies (name);
CREATE INDEX IF NOT EXISTS idx_companies_domain ON companies (domain);
CREATE INDEX IF NOT EXISTS idx_companies_country ON companies (country);
CREATE INDEX IF NOT EXISTS idx_companies_industry ON companies (industry);


CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_companies_updated_at ON companies;

CREATE TRIGGER trg_companies_updated_at
BEFORE UPDATE ON companies
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();


CREATE TABLE IF NOT EXISTS contacts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Relation
  company_id UUID,
  CONSTRAINT fk_contacts_company
    FOREIGN KEY (company_id)
    REFERENCES companies(id)
    ON DELETE SET NULL,

  -- Identity
  email              VARCHAR(255) UNIQUE,
  email_domain       VARCHAR(255),
  email_status       VARCHAR(155) NOT NULL DEFAULT 'unknown',

  first_name         VARCHAR(120),
  last_name          VARCHAR(120),

  -- Job info
  job_title          VARCHAR(255),     -- jobtitle
  job_level          VARCHAR(120),     -- job_level__c

  linkedin_url       TEXT,             -- linkedinurl__c

  -- Location (person)
  address_line1      TEXT,
  full_address       TEXT,
  city               VARCHAR(120),
  state              VARCHAR(120),
  province           VARCHAR(120),
  postal_code        VARCHAR(30),
  country            VARCHAR(120),

  -- Enrichment
  connections_count  INTEGER,          -- Conn

  -- Lead management
  lead_temp          VARCHAR(55) NOT NULL DEFAULT 'cold',
  lead_stage         VARCHAR(55) NOT NULL DEFAULT 'new',
  lead_score         INTEGER NOT NULL DEFAULT 0,

  -- Timestamps
  created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_contacts_company_id ON contacts (company_id);
CREATE INDEX IF NOT EXISTS idx_contacts_email_domain ON contacts (email_domain);
CREATE INDEX IF NOT EXISTS idx_contacts_lead_temp ON contacts (lead_temp);
CREATE INDEX IF NOT EXISTS idx_contacts_lead_stage ON contacts (lead_stage);

-- updated_at trigger
DROP TRIGGER IF EXISTS trg_contacts_updated_at ON contacts;

CREATE TRIGGER trg_contacts_updated_at
BEFORE UPDATE ON contacts
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();


-- 1) Enum for job status
DO $$ BEGIN
  CREATE TYPE export_job_status AS ENUM (
    'queued',
    'processing',
    'completed',
    'failed'
  );
EXCEPTION
  WHEN duplicate_object THEN null;
END $$;

-- 2) Export jobs table
CREATE TABLE IF NOT EXISTS public.export_jobs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  entity text NOT NULL,              -- 'contacts' | 'companies'
  mode text NOT NULL,                -- 'selected' | 'filtered'
  format text NOT NULL,              -- 'csv' | 'excel'
  status text NOT NULL DEFAULT 'queued',  -- queued | processing | completed | failed

  headers jsonb NOT NULL,
  ids jsonb,
  query jsonb,

  row_count int,
  file_name text,
  file_path text,                    -- where you saved it in project directory
  file_size_bytes bigint,

  error_message text,

  created_at timestamptz NOT NULL DEFAULT now(),
  started_at timestamptz,
  finished_at timestamptz,
  delivered_at timestamptz           -- when user actually downloads
);

CREATE INDEX IF NOT EXISTS idx_export_jobs_user_created
  ON public.export_jobs (user_id, created_at DESC);

-- Helpful indexes
CREATE INDEX IF NOT EXISTS idx_export_jobs_user_id_created_at
  ON public.export_jobs (user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_export_jobs_status_created_at
  ON public.export_jobs (status, created_at DESC);

  ALTER TABLE public.export_jobs
ADD COLUMN IF NOT EXISTS download_token text,
ADD COLUMN IF NOT EXISTS download_token_expires_at timestamptz,
ADD COLUMN IF NOT EXISTS email_sent_at timestamptz;

CREATE INDEX IF NOT EXISTS export_jobs_download_token_idx
ON public.export_jobs (download_token);


-- sync_jobs: one row per sync run
CREATE TABLE IF NOT EXISTS sync_jobs (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('queued','running','completed','failed')),
  progress INT NOT NULL DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),

  options JSONB NOT NULL DEFAULT '{}'::jsonb,
  result JSONB,
  error TEXT,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  finished_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_sync_jobs_user_created
  ON sync_jobs (user_id, created_at DESC);

-- sync_tasks: one row per task inside a job (companies / contacts)
CREATE TABLE IF NOT EXISTS sync_tasks (
  id UUID PRIMARY KEY,
  job_id UUID NOT NULL REFERENCES sync_jobs(id) ON DELETE CASCADE,

  key TEXT NOT NULL CHECK (key IN ('companies','contacts')),
  label TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('queued','running','completed','failed')),
  progress INT NOT NULL DEFAULT 0 CHECK (progress >= 0 AND progress <= 100),

  started_at TIMESTAMPTZ,
  finished_at TIMESTAMPTZ,
  error TEXT,
  result JSONB,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- prevent duplicates per job
CREATE UNIQUE INDEX IF NOT EXISTS ux_sync_tasks_job_key
  ON sync_tasks (job_id, key);

CREATE INDEX IF NOT EXISTS idx_sync_tasks_job
  ON sync_tasks (job_id);

-- 1) Enums (optional but nice)
DO $$ BEGIN
  CREATE TYPE email_verify_job_type AS ENUM ('single', 'batch_async', 'batch_sync');
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
  CREATE TYPE email_verify_job_status AS ENUM ('queued', 'processing', 'completed', 'failed', 'cancelled');
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
  CREATE TYPE email_verify_provider AS ENUM ('bouncer');
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

-- 2) Jobs table
CREATE TABLE IF NOT EXISTS email_verification_jobs (
  id                  uuid PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Your user
  user_id             uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- Provider
  provider            email_verify_provider NOT NULL DEFAULT 'bouncer',
  job_type            email_verify_job_type NOT NULL,

  -- Our status
  status              email_verify_job_status NOT NULL DEFAULT 'queued',

  -- Provider identifiers (batchId for async batches; NULL for single)
  provider_batch_id   text NULL,

  -- Inputs / file
  input_source        text NULL,           -- e.g. 'ui-single', 'csv-upload', 'api'
  file_name           text NULL,
  file_size_bytes     bigint NULL,

  -- Counts
  quantity_submitted  integer NOT NULL DEFAULT 0,   -- emails sent to provider
  duplicates          integer NOT NULL DEFAULT 0,   -- if provider reports duplicates
  processed           integer NOT NULL DEFAULT 0,   -- processed by provider (status endpoint)
  stats_deliverable   integer NOT NULL DEFAULT 0,
  stats_risky         integer NOT NULL DEFAULT 0,
  stats_undeliverable integer NOT NULL DEFAULT 0,
  stats_unknown       integer NOT NULL DEFAULT 0,

  -- Credit tracking (what provider reported / what we charged)
  credits_reserved    integer NOT NULL DEFAULT 0,   -- optional reserve
  credits_consumed    integer NOT NULL DEFAULT 0,   -- actual used
  credits_refunded    integer NOT NULL DEFAULT 0,   -- finish/partial returns

  -- Timestamps
  requested_at        timestamptz NOT NULL DEFAULT now(),  -- when user clicked
  provider_created_at timestamptz NULL,                    -- from provider 'created'
  started_at          timestamptz NULL,                    -- from provider 'started' or first poll shows processing
  completed_at        timestamptz NULL,                    -- from provider 'completed'
  failed_at           timestamptz NULL,

  -- Errors
  error_code          text NULL,     -- e.g. http status / provider reason
  error_message       text NULL,

  -- Raw payloads for debugging/audit
  request_payload     jsonb NULL,    -- what we sent (emails or metadata)
  response_payload    jsonb NULL,    -- last/most important response
  last_status_payload jsonb NULL,    -- status poll response
  callback_payload    jsonb NULL     -- if you use callback URL
);

CREATE INDEX IF NOT EXISTS idx_email_verification_jobs_user
  ON email_verification_jobs(user_id, requested_at DESC);

CREATE UNIQUE INDEX IF NOT EXISTS uq_email_verification_jobs_provider_batch
  ON email_verification_jobs(provider, provider_batch_id)
  WHERE provider_batch_id IS NOT NULL;

  DO $$ BEGIN
  CREATE TYPE email_verify_status AS ENUM ('deliverable', 'risky', 'undeliverable', 'unknown');
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

CREATE TABLE IF NOT EXISTS email_verification_results (
  id                uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id            uuid NOT NULL REFERENCES email_verification_jobs(id) ON DELETE CASCADE,

  email             text NOT NULL,
  status            email_verify_status NOT NULL,
  reason            text NULL,              -- provider enum like accepted_email, rejected_email, etc.
  score             integer NULL,           -- 0..100
  provider_name     text NULL,              -- e.g. google.com
  retry_after       text NULL,              -- optional

  -- Domain object
  domain_name       text NULL,
  domain_accept_all text NULL,              -- 'yes'/'no' as strings per docs
  domain_disposable text NULL,
  domain_free       text NULL,

  -- Account object
  account_role      text NULL,
  account_disabled  text NULL,
  account_full      text NULL,

  -- DNS object
  dns_type          text NULL,
  dns_record        text NULL,

  toxic             text NULL,
  toxicity          integer NULL,           -- 0..5

  checked_at        timestamptz NOT NULL DEFAULT now(),

  -- Keep raw provider result (useful for changes/new fields)
  raw_result        jsonb NULL
);

CREATE INDEX IF NOT EXISTS idx_email_verification_results_job
  ON email_verification_results(job_id);

CREATE INDEX IF NOT EXISTS idx_email_verification_results_email
  ON email_verification_results(email);

DO $$ BEGIN
  CREATE TYPE credit_event_type AS ENUM ('reserve', 'consume', 'refund', 'adjustment');
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

CREATE TABLE IF NOT EXISTS credit_ledger (
  id            uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  job_id        uuid NULL REFERENCES email_verification_jobs(id) ON DELETE SET NULL,

  provider      email_verify_provider NOT NULL DEFAULT 'bouncer',
  event_type    credit_event_type NOT NULL,

  -- +credits for refund/adjustment, -credits for consume/reserve
  amount        integer NOT NULL CHECK (amount <> 0),

  -- Useful info
  note          text NULL,
  created_at    timestamptz NOT NULL DEFAULT now(),

  -- For audit/debug
  provider_ref  text NULL,      -- e.g. batchId
  meta          jsonb NULL
);

CREATE INDEX IF NOT EXISTS idx_credit_ledger_user_time
  ON credit_ledger(user_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_credit_ledger_job
  ON credit_ledger(job_id);

  CREATE TABLE IF NOT EXISTS email_verification_events (
  id          uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id      uuid NOT NULL REFERENCES email_verification_jobs(id) ON DELETE CASCADE,
  event_type  text NOT NULL,  -- e.g. created, status_poll, download, finish_called, callback_received
  http_status integer NULL,
  payload     jsonb NULL,
  created_at  timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_email_verification_events_job_time
  ON email_verification_events(job_id, created_at DESC);
